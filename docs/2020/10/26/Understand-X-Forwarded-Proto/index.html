<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Move Fast, Live Happily, With No End"><title>Understand X-Forwarded-Proto | Beendless ~ 快节奏,慢生活,无止境</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-38171545-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Understand X-Forwarded-Proto</h1><a id="logo" href="/.">Beendless ~ 快节奏,慢生活,无止境</a><p class="description">Move Fast, Live Happily, With No End</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Understand X-Forwarded-Proto</h1><div class="post-meta">2020-10-26</div><div class="post-content"><p>HTTP requests and HTTP responses use header fields to send information about the HTTP messages. Header fields are colon-separated name-value pairs that are separated by a carriage return (CR) and a line feed (LF). A standard set of HTTP header fields is defined in RFC 2616. There are also non-standard HTTP headers available that are widely used by the applications. Some of the non-standard HTTP headers have an X-Forwarded prefix. </p>
<p>The <code>X-Forwarded-Proto</code> request header helps you identify the protocol (HTTP or HTTPS) that a client used to connect to your servers. For example, if you host your website application behind a proxy server, let’s say AWS Loadbalancer. If there’s only one layer in front of the AWS load balancer, then the <code>X-Forwarded-Proto</code> value could be either <code>http</code> or <code>https</code> (it depends on how client connect to the load balancer). </p>
<p>Usually it won’t be an issue. But if you have multiple proxy servers in front of your application, for instance, user will have to go through CDN, WAF, Load balancer to hit your application, then the value of <code>X-Forwarded-Proto</code> depends on how the last two layers connect to each other instead of the protocal from client. Which means if user open the website with HTTPS mode, then you will have issue to set up the <code>secured cookie</code> in your HTTP response. </p>
<p>Here is an example, you set up an applicatio with ExpressJS under HTTPS model. In front your application, you have <code>Fastly</code>, <code>Imperva</code> and <code>AWS ALB</code>. Now if you are using <code>express-session</code> to set up your user session with below configuration:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy: true,</span><br><span class="line">cookie: &#123;</span><br><span class="line">  secure: true,</span><br><span class="line">  httpOnly: true,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then if you rely on the default value of <code>X-Forwarded-Proto</code> from <code>AWS ALB</code>, you are not able to set up the session cookie. You have to either force <code>AWS ALB</code> to pass <code>X-Forwarded-Proto</code> as <code>HTTPS</code> or you can write a simple middleware to ignore the value from load balancer like below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* eslint-disable no-param-reassign *&#x2F;</span><br><span class="line">app.use((req, res, next) &#x3D;&gt; &#123;</span><br><span class="line">  req.headers[&#39;x-forwarded-proto&#39;] &#x3D; &#39;https&#39;;</span><br><span class="line">  return next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


</div><div class="tags"><a href="/tags/HTTP/"><i class="fa fa-tag"></i>HTTP</a><a href="/tags/NodeJS/"><i class="fa fa-tag"></i>NodeJS</a><a href="/tags/AWS/"><i class="fa fa-tag"></i>AWS</a></div><div class="post-nav"><a class="pre" href="/2020/10/26/JavaScript-Async-Ready-Looping/">JavaScript Async Ready Looping</a><a class="next" href="/2020/10/09/Serving%20Files%20on%20S3%20through%20NodeJS/">Serving Files on S3 through NodeJS</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.beendless.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CS/">CS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%B2%E6%BD%AE%EF%B9%A3%E9%80%80%E6%BD%AE/">漲潮﹣退潮</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%84%A1%E7%9F%A5%EF%B9%A3%E6%97%A0%E7%9F%A5/">無知﹣无知</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A1%8C%E8%B5%B0%E7%9A%84%E6%A8%B9%E8%8B%97/">行走的樹苗</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Async/" style="font-size: 15px;">Async</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Machine-Learning/" style="font-size: 15px;">Machine Learning</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/NodeJS/" style="font-size: 15px;">NodeJS</a> <a href="/tags/Archetecture/" style="font-size: 15px;">Archetecture</a> <a href="/tags/Deep-Learning/" style="font-size: 15px;">Deep Learning</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/ConvnetJS/" style="font-size: 15px;">ConvnetJS</a> <a href="/tags/Google-Colab/" style="font-size: 15px;">Google Colab</a> <a href="/tags/CNN/" style="font-size: 15px;">CNN</a> <a href="/tags/Deep-Learning-with-TensorFlow-2-and-Keras/" style="font-size: 15px;">Deep Learning with TensorFlow 2 and Keras</a> <a href="/tags/AWS/" style="font-size: 15px;">AWS</a> <a href="/tags/Functional-Programming/" style="font-size: 15px;">Functional Programming</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/Algorithms/" style="font-size: 15px;">Algorithms</a> <a href="/tags/Leetcode/" style="font-size: 15px;">Leetcode</a> <a href="/tags/Binary-Search/" style="font-size: 15px;">Binary Search</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/08/12/Binary-Search-Deep-Dive/">Binary Search Code Template Deep Dive</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/06/Understand%20Golang's%20Function%20Type/">Understand Golang's Function Type</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/26/JavaScript-Async-Ready-Looping/">JavaScript Async Ready Looping</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/26/Understand-X-Forwarded-Proto/">Understand X-Forwarded-Proto</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/09/Serving%20Files%20on%20S3%20through%20NodeJS/">Serving Files on S3 through NodeJS</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/02/UsePureJSToAddWaterMarkForYourSite/">Add WaterMark with JavaScript to Your Website</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/03/Computer-Vision-Tasks-Summary/">Computer Vision Tasks Summary</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/31/Loading%20Image%20to%20Google%20Colab%20Notebooks/">Loading Image to Google Colab Notebooks</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/Building-Asynchronized-HTTP-Services-With-Sanic/">Building Asynchronized HTTP Services With Sanic</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/01/Several-Important-Concetps-of-CNN/">Several Important Concepts of CNN</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Beendless ~ 快节奏,慢生活,无止境.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>