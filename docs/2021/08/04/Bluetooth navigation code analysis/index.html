<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Move Fast, Live Happily, With No End"><title>Bluetooth navigation code analysis | Beendless ~ 快节奏,慢生活,无止境</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-38171545-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-38171545-1');</script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-56NRL5V');</script><script>(function(h,o,t,j,a,r){
    h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
    h._hjSettings={hjid:3218463,hjsv:6};
    a=o.getElementsByTagName('head')[0];
    r=o.createElement('script');r.async=1;
    r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
    a.appendChild(r);
})(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Bluetooth navigation code analysis</h1><a id="logo" href="/.">Beendless ~ 快节奏,慢生活,无止境</a><p class="description">Move Fast, Live Happily, With No End</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Bluetooth navigation code analysis</h1><div class="post-meta">2021-08-04<span> | </span><span class="category"><a href="/categories/CS/">CS</a></span></div><div class="post-content"><p>Recently, I found a source code about Bluetooth positioning and navigation. Through its analysis and research, I have a deep understanding of the positioning and navigation process of the entire Bluetooth algorithm. Learn about Bluetooth signal acquisition, distance estimation, positioning calculation, Kalman model and other aspects.</p>
<span id="more"></span>


<h3 id="structure"><a href="#structure" class="headerlink" title="structure"></a>structure</h3><p>LocationEngine core modules include: model manager, Bluetooth locator, geo-locator, motion detector, area monitor and other modules.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i.modelManager = new T.ModelManager(t), </span><br><span class="line">i.roadNetData = new d.RoadNetData(t),  </span><br><span class="line">i.navProcessor = new g.NavigationProcessor(t), </span><br><span class="line">i.bluetoothLocator = new l.BluetoothLocator(t), </span><br><span class="line">i.geoLocator = new c.GeoLocator(t), </span><br><span class="line">i.motionDetector = new u.MotionDetector(t), </span><br><span class="line">i.areaChecker = new f.AreaChecker(t), </span><br></pre></td></tr></table></figure>

<ul>
<li>ModelManager: Model manager.</li>
<li>RoadNetData: configuration-based road network data.</li>
<li>NavigationProcessor: Navigation processor.</li>
<li>BluetoothLocator: Bluetooth locator.</li>
<li>MotionDetector: Motion detector.</li>
</ul>
<h3 id="Bluetooth-Locator"><a href="#Bluetooth-Locator" class="headerlink" title="Bluetooth Locator"></a>Bluetooth Locator</h3><p>Locator initialization, default parameter settings and Bluetooth configuration information settings.</p>
<ul>
<li>set default parameters.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">value: function(t) &#123;</span><br><span class="line">    t || (t = &#123;&#125;),</span><br><span class="line">    this.REC_INTERVAL = t.RecInterval ? t.RecInterval : 5e3,</span><br><span class="line">    this.QUERY_INTERVAL = t.QueryInterval ? t.QueryInterval : 2e3,</span><br><span class="line">    this.Z_CHECK_INTERVAL = t.ZCheckInterval ? t.ZCheckInterval : 3e3,</span><br><span class="line">    this.ZInitTimeout = t.ZInitTimeout ? t.ZInitTimeout : 3e3,</span><br><span class="line">    this.deviceType = void 0 !== t.deviceType ? t.deviceType : s.CONSTANTS.DEVICE.ANDROID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Configure Bluetooth beacons.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;addAps&quot;,</span><br><span class="line">value: function(t) &#123;</span><br><span class="line">    t &amp;&amp; (t.forEach(function(t) &#123;</span><br><span class="line">        void 0 === t.z &amp;&amp; (t.z = t.re),</span><br><span class="line">        t.rssiList = []</span><br><span class="line">    &#125;),</span><br><span class="line">    this._aps = this._aps.concat(t))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>By obtaining the Bluetooth signal data, LocationEngine calls the bluetoothLocator.updateBeacons() method to calculate the location.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var n = this.bluetoothLocator.updateBeacons(i, t.value, this.posMode, this.isIndoor, this.kfPos)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Filter non-Bluetooth configuration beacons and invalid rssi signals, and update the Bluetooth beacon signal queue.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;updateApsByReceivedBeacons&quot;,</span><br><span class="line"> value: function(t, e) &#123;</span><br><span class="line">     var i = this;</span><br><span class="line">     e.forEach(function(e) &#123;</span><br><span class="line">         var n = i._matchAp(e.major, e.minor); </span><br><span class="line">         if (n &amp;&amp; &quot;-100&quot; !== e.rssi &amp;&amp; &quot;0&quot; !== e.rssi &amp;&amp; 0 !== e.rssi &amp;&amp; -100 !== e.rssi) &#123;</span><br><span class="line">             var r = n.rssiList.push(&#123;</span><br><span class="line">                 timestamp: t, </span><br><span class="line">                 rssi: parseInt(e.rssi)</span><br><span class="line">             &#125;);</span><br><span class="line">             n.status = 1,</span><br><span class="line">             r &gt; 15 &amp;&amp; n.rssiList.shift()</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get the current Bluetooth beacon, sort according to the signal strength, and set the Bluetooth beacon information strength.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">for (var d, v = l.rssiList[Symbol.iterator](); !(c = (d = v.next()).done); c = !0) &#123; </span><br><span class="line">           var p = d.value;</span><br><span class="line">           i - p.timestamp &lt; this.REC_INTERVAL &amp;&amp; n.push(&#123;</span><br><span class="line">               major: l.ma,</span><br><span class="line">               minor: l.mi,</span><br><span class="line">               x: l.x,</span><br><span class="line">               y: l.y,</span><br><span class="line">               region: l.re,</span><br><span class="line">               timestamp: p.timestamp,</span><br><span class="line">               rssi: p.rssi,</span><br><span class="line">               z: l.z</span><br><span class="line">           &#125;)  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Filter the beacons whose distance between the beacon position and the last beacon position is greater than 100, and the time is greater than 2s.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">h = (a = a.filter(function(t) &#123;</span><br><span class="line">               return !s || r.LocationUtils.distance(s, t) &lt;= 100 </span><br><span class="line">           &#125;)).filter(function(e) &#123;</span><br><span class="line">               return t - e.timestamp &lt; o.QUERY_INTERVAL</span><br><span class="line">           &#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>The filtered Bluetooth signals are sorted, and the first 5 are selected for weight and calculation, and the x and y position information is calculated according to the weight of the Bluetooth beacon.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;calBtPos&quot;,  </span><br><span class="line">            value: function(e, i, n, r, s) &#123;</span><br><span class="line">                if (0 === e.length) </span><br><span class="line">                    return null;</span><br><span class="line">                e.sort(function(t, e) &#123; </span><br><span class="line">                    return e.rssi - t.rssi</span><br><span class="line">                &#125;);</span><br><span class="line">                var o = e[0].rssi  </span><br><span class="line">                  , a = e.slice(0, 5); </span><br><span class="line">                t.calGradientWeight(a, o);  </span><br><span class="line">                var h = a.reduce(function(t, e) &#123;</span><br><span class="line">                    return t + e.weight</span><br><span class="line">                &#125;, 0) </span><br><span class="line">                  , l = t.calConfidence(a) </span><br><span class="line">                  , c = t.calNearAPCount(a, o, r, s</span><br><span class="line">                  , u = t.checkBoundaryState(a, n) </span><br><span class="line">                  , f = a.reduce(function(t, e) &#123;   </span><br><span class="line">                    return t + e.rssi</span><br><span class="line">                &#125;, 0) / a.length;</span><br><span class="line">                return &#123;</span><br><span class="line">                    x: a.reduce(function(t, e) &#123;  </span><br><span class="line">                        return t + e.x * e.weight</span><br><span class="line">                    &#125;, 0) / h,</span><br><span class="line">                    y: a.reduce(function(t, e) &#123; </span><br><span class="line">                        return t + e.y * e.weight</span><br><span class="line">                    &#125;, 0) / h,</span><br><span class="line">                    z: parseFloat(i), //</span><br><span class="line">                    c: l, </span><br><span class="line">                    p: c, </span><br><span class="line">                    s: u, </span><br><span class="line">                    m: f </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Motion-Detector"><a href="#Motion-Detector" class="headerlink" title="Motion Detector"></a>Motion Detector</h3><ul>
<li>LocationEngine update accelerometer mode.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;updateAccSensorMode&quot;, </span><br><span class="line">value: function() &#123;</span><br><span class="line">    this.motionDetector ? this.accSensorStatus = this.motionDetector.getAccSensorStatus() : this.accSensorStatus = P.CONSTANTS.ACC_SENSOR_STATUS.EMPTY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Set accelerometer mode according to accelerometer frequency.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;checkAccSensorMode&quot;, </span><br><span class="line">value: function(t) &#123;</span><br><span class="line">    t - this.startTime &lt; this.gravityTimeLen || (this.gravityList &amp;&amp; 0 === this.gravityList.length &amp;&amp; (this.accSensorStatus = o.CONSTANTS.ACC_SENSOR_STATUS.EMPTY),</span><br><span class="line">    this.accCompBuffer.reduce(function(t, e) &#123;</span><br><span class="line">        return t + e</span><br><span class="line">    &#125;, 0) / this.accCompBufferLen &gt; 9 &amp;&amp; (this.accFreq = 1e3 * this.gravityList.length / this.gravityTimeLen,</span><br><span class="line">    this.accFreq &lt; 13 ? this.accSensorStatus = o.CONSTANTS.ACC_SENSOR_STATUS.LOW_FREQ : this.accFreq &gt;= 22 &amp;&amp; (this.accSensorStatus = o.CONSTANTS.ACC_SENSOR_STATUS.NORMAL)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>By obtaining the compass data, LocationEngine calls the motionDetector.updateHeading() method and passes in the angle value of the current device.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;updateHeading&quot;, </span><br><span class="line">             value: function(t) &#123;</span><br><span class="line">                 this.headingChange = this.headingFlag ? t.value.heading - this.headingDeg : 0,</span><br><span class="line">                 this.headingDeg = t.value.heading, </span><br><span class="line">                 this.motionDetector.updateHeading(t.timestamp, t.value.heading),</span><br><span class="line">                 this.headingFlag = !0</span><br><span class="line">             &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>LocationEngine calls the motionDetector.detectMotion() method to process the acceleration data.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;updateAcc&quot;, </span><br><span class="line">   var n = this.motionDetector.detectMotion(t, e, i);  </span><br></pre></td></tr></table></figure>

<ul>
<li>By analyzing and processing the motion state of the device, the number of steps, step length, mobile phone posture, motion state, etc. are obtained.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">this.motionResult = Object.assign(&#123;</span><br><span class="line">                       t: t,  </span><br><span class="line">                       stepDetected: a, </span><br><span class="line">                       step: h,</span><br><span class="line">                       phonePlacement: this.phonePlacement,</span><br><span class="line">                       motionState: this.motionState </span><br><span class="line">                   &#125;, l  )</span><br></pre></td></tr></table></figure>

<ul>
<li>step counting<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;detectStep&quot;, </span><br><span class="line">              value: function(t, e, i) &#123;</span><br><span class="line">                  var n = !1; </span><br><span class="line">                  return 0 !== this.peakTime   </span><br><span class="line">                              &amp;&amp; this.peakValleyPair.pvDiff &gt; this.PeakValleyTh </span><br><span class="line">                              &amp;&amp; t - this.peakTime &gt; this.MinPeakInterval </span><br><span class="line">                              &amp;&amp; this.peakTime - this.stepTime &gt; this.MinStepInterval </span><br><span class="line">                              &amp;&amp; (this.stepTime = this.peakTime,</span><br><span class="line">                                     this.stepCount += 1,</span><br><span class="line">                                     this.saver &amp;&amp; </span><br><span class="line">                                     this.saver.saveStepResult(this.stepTime, this.peakValleyPair.peak, this.peakValleyPair.valley, this.PeakValleyTh),</span><br><span class="line">                                     n = !0),</span><br><span class="line">                              e &lt; this.valleyValue </span><br><span class="line">                              &amp;&amp; (this.valleyValue = e,this.valleyTime = t),</span><br><span class="line">                             this.validValleyValue = t - this.lastValleyVTime &lt; 2 * this.MinStepInterval </span><br><span class="line">                                  &amp;&amp; this.lastValleyVTime &gt; this.stepTime </span><br><span class="line">                                  &amp;&amp; this.lastValleyValue &lt; this.valleyValue ? this.lastValleyValue : this.valleyValue,</span><br><span class="line">                             0 !== i &amp;&amp; 1 === this.detectPeak(t, e, i)  </span><br><span class="line">                                   &amp;&amp; i - this.validValleyValue &gt; 1.3 </span><br><span class="line">                                   &amp;&amp; (this.saver &amp;&amp; this.saver.savePeakResult(t, i, this.validValleyValue, i - this.validValleyValue), //</span><br><span class="line">                             t - this.peakTime &gt; this.MinPeakInterval &amp;&amp; (this.PeakValleyTh = this.peakValleyThresholdUpdate(i - this.validValleyValue),</span><br><span class="line">                            this.lastValleyValue = this.valleyValue,</span><br><span class="line">                            this.lastValleyVTime = this.valleyTime,</span><br><span class="line">                            this.valleyValue = 100,</span><br><span class="line">                            this.peakTime = t,</span><br><span class="line">                            this.peakValleyPair = &#123;</span><br><span class="line">                                   peak: i,</span><br><span class="line">                                   valley: this.validValleyValue,</span><br><span class="line">                                  pvDiff: i - this.validValleyValue</span><br><span class="line">                                  &#125;),</span><br><span class="line">                            t - this.peakTime &lt;= this.MinPeakInterval </span><br><span class="line">                               &amp;&amp; i &gt; this.peakValleyPair.peak &amp;&amp; (this.peakTime = t,</span><br><span class="line">                                      this.validValleyValue = this.validValleyValue &lt; this.peakValleyPair.valley ? this.validValleyValue : this.peakValleyPair.valley,</span><br><span class="line">                                      this.peakValleyPair = &#123;</span><br><span class="line">                                           peak: i,</span><br><span class="line">                                           valley: this.validValleyValue,</span><br><span class="line">                                           pvDiff: i - this.validValleyValue</span><br><span class="line">                              &#125;)),</span><br><span class="line">                           n</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Model-Manager"><a href="#Model-Manager" class="headerlink" title="Model Manager"></a>Model Manager</h3><ul>
<li><p>Kalman filter model setting parameters。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i.pdrKf = new o.KalmanFilterPDR(i.t,a.KF_TYPE.PDR_WLK,t.deviceType,t.params),</span><br><span class="line">i.diffKf = new s.KalmanFilterDiffHeading(i.t,a.KF_TYPE.DIFF_WLK,t.deviceType,t.params),</span><br><span class="line">i.baseKf = new s.KalmanFilterDiffHeading(i.t,a.KF_TYPE.DIFF_BASE,t.deviceType,t.params),</span><br><span class="line">i.drvKf = new s.KalmanFilterDiffHeading(i.t,a.KF_TYPE.DIFF_DRV,t.deviceType,t.params),</span><br></pre></td></tr></table></figure>
</li>
<li><p>When the location engine gets new location information, it will pass this information to the model manager for processing and analysis. The model manager updates the Kalman filter model based on the current location state and historical data.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;updateFusionModels&quot;, </span><br><span class="line">value: function(t, e, i, n, r, s, o, a, l, u) &#123;</span><br><span class="line">    if (this.started || this.checkInitSignal(t, n, r) &amp;&amp; (this.t = t,</span><br><span class="line">    this.started = !0,</span><br><span class="line">    this.z = e,</span><br><span class="line">    this.isARLast(this.arLastPos, n, r)),</span><br><span class="line">    this.started) &#123; </span><br><span class="line">        e !== this.z &amp;&amp; (this.z = e,</span><br><span class="line">        h.LocationUtils.distance(i, n) &lt; h.LocationUtils.distance(i, r) &amp;&amp; h.LocationUtils.distance(i, n) &lt; 10 ? this.reStartModels(n, null) : this.reStartModels(n, r));</span><br><span class="line">        this.t;</span><br><span class="line">        this.t = t,</span><br><span class="line">        this.pdrKf.update(t, n, r, s, o, a, l, u),</span><br><span class="line">        this.diffKf.update(t, n, r, s, l, u),</span><br><span class="line">        this.baseKf.update(t, n, r, void 0, u),</span><br><span class="line">        this.drvKf.update(t, n, r, s, !1, u),</span><br><span class="line">        this.drvOutKF.update(t, n, r, s, l),</span><br><span class="line">        this.updateBaseKfInfos(c.Numerical.rad2deg(s))  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kafman filter direction angle。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;getHeadingDeg&quot;,</span><br><span class="line">value: function() &#123;</span><br><span class="line">    if (this.kalmanModel)</span><br><span class="line">        return h.Numerical.rad2deg(Math.atan2(this.kalmanModel.x_k.elements[1], this.kalmanModel.x_k.elements[3]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Get Kalman filter position.</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;getPosition&quot;,</span><br><span class="line">value: function() &#123;</span><br><span class="line">    if (this.kalmanModel)</span><br><span class="line">        return &#123;</span><br><span class="line">            x: this.kalmanModel.x_k.elements[0],</span><br><span class="line">            y: this.kalmanModel.x_k.elements[2]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Get the Kalman filter speed.</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key: &quot;getVelocity&quot;,</span><br><span class="line">value: function() &#123;</span><br><span class="line">    if (this.kalmanModel)</span><br><span class="line">        return &#123;</span><br><span class="line">            x: this.kalmanModel.x_k.elements[1],</span><br><span class="line">            y: this.kalmanModel.x_k.elements[3]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Bluetooth/"><i class="fa fa-tag"></i>Bluetooth</a><a href="/tags/GEO-Location/"><i class="fa fa-tag"></i>GEO Location</a></div><div class="post-nav"><a class="pre" href="/2021/08/12/Binary-Search-Deep-Dive/">Binary Search Code Template Deep Dive</a><a class="next" href="/2021/08/04/Indoor%20bluetooth%20location/">Bluetooth navigation code analysis</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.beendless.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CS/">CS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Recipe/">Recipe</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%B2%E6%BD%AE%EF%B9%A3%E9%80%80%E6%BD%AE/">漲潮﹣退潮</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%84%A1%E7%9F%A5%EF%B9%A3%E6%97%A0%E7%9F%A5/">無知﹣无知</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A1%8C%E8%B5%B0%E7%9A%84%E6%A8%B9%E8%8B%97/">行走的樹苗</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Machine-Learning/" style="font-size: 15px;">Machine Learning</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/Algorithms/" style="font-size: 15px;">Algorithms</a> <a href="/tags/Leetcode/" style="font-size: 15px;">Leetcode</a> <a href="/tags/Backtracking/" style="font-size: 15px;">Backtracking</a> <a href="/tags/Subsets/" style="font-size: 15px;">Subsets</a> <a href="/tags/Binary-Search/" style="font-size: 15px;">Binary Search</a> <a href="/tags/Array/" style="font-size: 15px;">Array</a> <a href="/tags/HashMap/" style="font-size: 15px;">HashMap</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Async/" style="font-size: 15px;">Async</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/CNN/" style="font-size: 15px;">CNN</a> <a href="/tags/Deep-Learning-with-TensorFlow-2-and-Keras/" style="font-size: 15px;">Deep Learning with TensorFlow 2 and Keras</a> <a href="/tags/Binary-Tree/" style="font-size: 15px;">Binary Tree</a> <a href="/tags/Queue/" style="font-size: 15px;">Queue</a> <a href="/tags/Stack/" style="font-size: 15px;">Stack</a> <a href="/tags/Linked-List/" style="font-size: 15px;">Linked List</a> <a href="/tags/Dynamic-Programming/" style="font-size: 15px;">Dynamic Programming</a> <a href="/tags/DFS/" style="font-size: 15px;">DFS</a> <a href="/tags/Knapsack/" style="font-size: 15px;">Knapsack</a> <a href="/tags/Two-Pointers/" style="font-size: 15px;">Two Pointers</a> <a href="/tags/Greedy/" style="font-size: 15px;">Greedy</a> <a href="/tags/Bucket-Sort/" style="font-size: 15px;">Bucket Sort</a> <a href="/tags/Top-K-Frequent/" style="font-size: 15px;">Top K Frequent</a> <a href="/tags/Heap/" style="font-size: 15px;">Heap</a> <a href="/tags/Priority-Queue/" style="font-size: 15px;">Priority Queue</a> <a href="/tags/Functional-Programming/" style="font-size: 15px;">Functional Programming</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/JumpGame/" style="font-size: 15px;">JumpGame</a> <a href="/tags/BFS/" style="font-size: 15px;">BFS</a> <a href="/tags/Sliding-Window/" style="font-size: 15px;">Sliding Window</a> <a href="/tags/Google-Colab/" style="font-size: 15px;">Google Colab</a> <a href="/tags/Mastering-Go/" style="font-size: 15px;">Mastering Go</a> <a href="/tags/Chinese-Food/" style="font-size: 15px;">Chinese Food</a> <a href="/tags/Monotonic-Stack/" style="font-size: 15px;">Monotonic Stack</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Kubernetes/" style="font-size: 15px;">Kubernetes</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/NodeJS/" style="font-size: 15px;">NodeJS</a> <a href="/tags/Archetecture/" style="font-size: 15px;">Archetecture</a> <a href="/tags/AWS/" style="font-size: 15px;">AWS</a> <a href="/tags/Deep-Learning/" style="font-size: 15px;">Deep Learning</a> <a href="/tags/ConvnetJS/" style="font-size: 15px;">ConvnetJS</a> <a href="/tags/Stock-Exchange/" style="font-size: 15px;">Stock Exchange</a> <a href="/tags/Matrix/" style="font-size: 15px;">Matrix</a> <a href="/tags/String/" style="font-size: 15px;">String</a> <a href="/tags/KMP/" style="font-size: 15px;">KMP</a> <a href="/tags/Time-complexity/" style="font-size: 15px;">Time complexity</a> <a href="/tags/Bluetooth/" style="font-size: 15px;">Bluetooth</a> <a href="/tags/GEO-Location/" style="font-size: 15px;">GEO Location</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/11/15/Set%20up%20Kubeadm%20on%20Macbook%20with%20Vagrant/">Set up Kubeadm on MacOS with Vagrant and VirtualBox</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/26/Ma-Po%20Tofu/">MMM, Ma-Po Tofu !</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/19/Multi-Stage%20Golang%20Docker%20Image/">Multi-Stage Golang Docker Image Build and Kubernetes Deployment</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/18/Mastering%20Go%20Notes/">Mastering Go Notes</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/16/Monotonic%20Stack/">Monotonic Stack</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/14/Dynamic%20Programming%20IV/">Dynamic Programming IV</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/13/Dynamic%20Programming%20III/">Dynamic Programming III</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/12/Stock%20Exchange%20Problems/">Stock Exchange Problems</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/09/Knapsack%20Problem%20II/">Knapsack Problems II</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/08/Dynamic%20Programming%20II/">Dynamic Programming II</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Beendless ~ 快节奏,慢生活,无止境.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>